---
- name: apt-get install git
  apt:
    name: git
    state: present

- name: chown debian /srv
  file:
    path: /srv
    owner: debian

- name: git clone https://lab.securedrop.club/main/sd-helper
  git:
    repo: https://lab.securedrop.club/main/sd-helper
    version: origin/wip-docker
    force: yes
    dest: /srv/sd-helper
  become: False

- name: cleanup docker leftovers
  shell: docker system prune --force
  become: False

- name: build sd-helper image
  shell: docker build -t sd-helper /srv/sd-helper
  become: False

- name: run sd-helper container
  docker_container:
    name: sd-helper
    image: sd-helper
    restart_policy: always
    env:
      GITTER_API_TOKEN: "{{ GITTER_API_TOKEN }}"
      GITTER_ROOM_ID: "{{ GITTER_ROOM_ID }}"
    state: started
