---
- name: setup DNS client (allow-recursion)
  hosts: all:!external-host
  become: true
  serial: 1 # so blockinfile does not race against itslef

  tasks:
    - name: allow recursion for {{ ansible_hostname }}
      blockinfile:
        path: /etc/bind/named.conf.allow-recursion
        insertafter: allow-recursion {
        marker: "# {mark} ansible managed {{ ansible_host }}"
        content: "{{ ansible_host }};"
      delegate_to: bind-host

- name: setup DNS client (A/CNAME records)
  hosts: all:!external-host
  become: true

  tasks:
    - name: install BIND A/CNAME records
      shell: |
        nsupdate <<EOF
        server localhost
        zone {{ domain }}
        update add {{ bind_client_hostname }}.{{ domain }}. 1800 A {{ bind_client_ip }}
        update add {{ bind_client_hostname | replace("-host","") }}.{{ domain }}. 1800 CNAME {{ bind_client_hostname }}.{{ domain }}.
        show
        send
        quit
        EOF
      delegate_to: bind-host
      vars:
        bind_client_hostname: "{{ ansible_hostname }}"
        bind_client_ip: "{{ ansible_host }}"

- name: setup DNS client (dhclient, ssh_records, hostname)
  hosts: all:!external-host
  become: true

  roles:
    - role: dhclient
      dns_nameservers: ['{{ hostvars["bind-host"]["ansible_host"] }}']
      dns_search: "{{ domain }}"
      dns_domain: "{{ domain }}"

    - role: install_ssh_records
      vars:
        install_ssh_records_host: "{{ ansible_hostname }}"
        install_ssh_records_port: "{{ ansible_port }}"

  tasks:
    - name: set hostname
      hostname:
        name: '{{ inventory_hostname }}.{{ domain }}'
