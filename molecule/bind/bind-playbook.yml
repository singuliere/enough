---
- name: configure firewall
  hosts: localhost
  connection: local
  gather_facts: False

  roles:
    - role: firewall
      os_security_group_udp_external: [ 53 ]

- name: setup DNS server
  hosts: bind-host
  become: True

  vars:
    domain: 'securedrop.club'
  roles:
    - role: bind
      bind_zone_name: "{{ domain }}"
      bind_master:
        - |
          options {
            directory "/var/cache/bind";
            auth-nxdomain no;    # conform to RFC1035
            listen-on-v6 { any; };
            allow-query { any; };
            recursion yes;
            allow-recursion {
              {% for host, info in hostvars.items() %}
              {% if host != 'external-host' %}
              {{ info.ansible_host }}; # {{ host }}
              {% endif %}
              {% endfor %}
            };
            allow-transfer  {
              217.70.177.40/32; # ns6.gandi.net
            };
          };

          include "/etc/bind/named.conf.default-zones";

          zone "{{ domain }}" IN {
            type master;
            file "{{ domain }}";
            notify yes;
            allow-update { none; };
          };

      bind_zone:
        - |
          $ORIGIN {{ domain }}.
          $TTL 1W

          @ IN SOA ns1.{{ domain }}. hostmaster.{{ domain }}. (
          {{ bind_timestamp.stdout }}
          1D
          1H
          1W
          1D )

                     IN  NS     ns1.{{ domain }}.
                     IN  NS     ns6.gandi.net.

          @ 1800 IN A 217.182.87.182
          ns1 1800 IN A {{ hostvars[inventory_hostname].ansible_host }}

          ansible 1800 IN A 54.36.113.45

          demo 1800 IN A 147.135.193.226
          journalist.demo 1800 IN CNAME demo
          source.demo 1800 IN CNAME demo

          i18n 1800 IN A 54.36.52.252
          source.i18n 1800 IN CNAME i18n
          journalist.i18n 1800 IN CNAME i18n

          forum 1800 IN A 217.182.87.182
          www 1800 IN CNAME forum

          lab 1800 IN A 145.239.15.86

          ns1-test 1800 IN A 54.37.76.14
          test 1800 IN NS ns1-test.securedrop.club.

          imap 1800 IN CNAME access.mail.gandi.net.
          pop 1800 IN CNAME access.mail.gandi.net.
          smtp 1800 IN CNAME relay.mail.gandi.net.

          @ 1800 IN MX 50 fb.mail.gandi.net.
          @ 1800 IN MX 10 spool.mail.gandi.net.

          {% for host, info in hostvars.items() %}
          {{ host }} 1800 IN A {{ info.ansible_host }}
          {{ host|replace("-host","") }} 1800 IN CNAME {{ host }}
          {% endfor %}
