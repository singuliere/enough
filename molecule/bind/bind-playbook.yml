---
- name: configure firewall
  hosts: localhost
  connection: local
  gather_facts: False

  roles:
    - role: firewall
      os_security_group_udp_external: [ 53 ]

- name: setup DNS server
  hosts: bind-host
  become: True

  vars:
    domain: 'securedrop.club'
    bind_zone_hosts_dynamic: |
      [
        {% for host, info in hostvars.items() %}
        {
          'name': '{{ host }}',
          'ip': '{{ info.ansible_host }}',
          'aliases': ['{{ host|replace("-host","") }}'],
        },
        {% endfor %}
      ]
    bind_zone_hosts_static:
      - name: ns1
        ip: '{{ hostvars["bind-host"]["ansible_host"] }}'
      - name: ns1-test
        ip: 1.2.3.4
      - name: ansible
        ip: 54.36.113.45
      - name: lab
        ip: 145.239.15.86
      - name: demo
        ip: 147.135.193.226
        aliases: [ 'journalist.demo', 'source.demo' ]
      - name: i18n
        ip: 54.36.52.252
        aliases: [ 'journalist.i18n', 'source.i18n' ]
      - name: '@'
        ip: 217.182.87.182
      - name: forum
        ip: 217.182.87.182
        aliases: [ 'www' ]
      - name: relay.mail.gandi.net.
        aliases: [ 'smtp' ]
      - name: access.mail.gandi.net.
        aliases: [ 'pop', 'imap' ]

  roles:
    - role: bertvv.bind
      bind_allow_query:
        - any
      bind_listen_ipv4:
        - any
      bind_recursion: true
      bind_allow_recursion: |
        [
          {% for host, info in hostvars.items() %}
          {% if host != 'external-host' %}
          '{{ info.ansible_host }}',
          {% endif %}
          {% endfor %}
        ]
      bind_zone_name: '{{ domain }}'
      bind_zone_master_server_ip: '{{ hostvars["bind-host"]["ansible_host"] }}'
      bind_zone_name_servers:
        - ns1
      bind_zone_hosts: '{{ bind_zone_hosts_dynamic + bind_zone_hosts_static }}'
      bind_zone_delegate:
        - zone: test
          dns: ns1-test.securedrop.club.
      bind_zone_mail_servers:
        - name: fb.mail.gandi.net.
          preference: 50
        - name: spool.mail.gandi.net.
          preference: 10
      bind_zone_text:
        - name: '@'
          text: 'v=spf1 mx ?all'
        - name: '_dmarc'
          text: 'v=DMARC1; p=none;'
