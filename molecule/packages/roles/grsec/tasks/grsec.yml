---
- name: apt-get install virtualenv
  apt:
    name: virtualenv
    state: present
  become: yes

- name: apt-get install python-pip
  apt:
    name: python-pip
    state: present
  become: yes

- name: pip install setuptools
  pip:
    name: setuptools
  become: yes

- name: pip install docker
  pip:
    name: docker
  become: yes

- name: apt-get install dependencies
  apt:
    name: "{{ item }}"
  with_items:
    - bc
    - build-essential
    - curl
    - fakeroot
    - gcc-6
    - gcc-6-plugin-dev
    - libncurses5-dev
    - make
    - python-requests
    - libssl-dev
    - rsync
  become: yes

- name: chown debian /opt
  file:
    path: /opt
    owner: debian
  become: yes

- name: wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.135.tar.xz
  get_url:
    dest: /opt/linux-4.4.135.tar.xz
    url: https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.135.tar.xz
    # wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.134.tar.xz
    # xz -d linux-4.4.135.tar.xz
    # wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.135.tar.sign
    # gpg --no-options --keyid-format 0xlong --verify linux-4.4.135.tar.sign linux-4.4.135.tar
    sha256sum: 03ccb008824e363d9f83245676b9e0602f604c880dd10577653f3328c37781dc

- name: tar Jxf linux-4.4.135.tar.xz
  shell: tar Jxf linux-4.4.135.tar.xz
  args:
    chdir: /opt
    creates: linux-4.4.135

#
# Instructions to get the diff
#
# ask for the kernel sources following instructions at
#
#   https://github.com/freedomofpress/securedrop/blob/develop/SOURCE_OFFER
#
# and download linux-4.4.135-grsec_4.4.135-grsec.orig.tar.gz from the
# location specified in the mail answering the request.
# gpg --no-options --keyid-format 0xlong --verify linux-4.4.135-grsec_4.4.135-grsec.orig.tar.gz.gpg linux-4.4.135-grsec_4.4.135-grsec.orig.tar.gz
#
# tar zxvf linux-4.4.135-grsec_4.4.135-grsec.orig.tar.gz
# wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.135.tar.xz
# tar xf linux-4.4.135.tar
# git diff linux-4.4.135 linux-4.4.135-grsec > grsec-4.4.135.diff
#
- name: copy grsec-4.4.135.diff
  copy:
    src: grsec-4.4.135.diff
    dest: /opt/grsec-4.4.135.diff

- name: patch < grsec-*.diff
  shell: |
    cat grsec-4.4.135.diff | ( cd linux-4.4.135 && patch -p2 ) && touch patch.done
  args:
    chdir: /opt
    creates: patch.done

- name: create docker directory
  file:
    path: docker
    state: directory

- name: copy Dockerfile
  copy:
    src: Dockerfile
    dest: docker/Dockerfile

- name: build trusty image
  shell: docker build -t trusty-builder docker
  become: yes

- name: check existence of /opt/linux-4.4.135-grsec_4.4.135-grsec-1.dsc
  shell: test -e /opt/linux-4.4.135-grsec_4.4.135-grsec-1.dsc
  register: packages_exist
  ignore_errors: yes

- name: get rid of any build container leftover
  docker_container:
    name: trusty-builder
    state: absent
  become: yes
  when: packages_exist.rc != 0

- name: build linux packages
  docker_container:
    name: trusty-builder
    image: trusty-builder
    volumes:
      - /opt:/opt
    working_dir: /opt/linux-4.4.135
    restart_policy: false
    detach: no
  become: yes
  when: packages_exist.rc != 0

#
# we could use
#
#   auto_remove: yes
#
# above instead of explicitly destroying the container.  But it
# appears to race against displaying the logs as suggested by the
# following error which shows up sometimes:
#
#    can not get logs from container which is dead or marked for removal
#
- name: remove the build container
  docker_container:
    name: trusty-builder
    state: absent
  become: yes
  when: packages_exist.rc != 0

- name: rsync linux* .
  synchronize:
    src: /opt
    dest: linux-packages
    recursive: yes
    rsync_opts:
      - --exclude=linux-4.4.135
      - --exclude=linux-4.4.135.tar.xz
      - --exclude=grsec-4.4.135.diff
      - --exclude=patched.done
    mode: pull
