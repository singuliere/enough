#!/bin/bash

set -e

echo ======================================================================
date
echo ======================================================================

cd /srv

wget -c https://apt-test.freedom.press/pool/main/l/linux-source-3.14.79-grsec/linux-image-3.14.79-grsec_3.14.79-grsec-11.00.Custom_amd64.deb
wget -c https://apt-test.freedom.press/pool/main/l/linux-source-3.14.79-grsec/linux-headers-3.14.79-grsec_3.14.79-grsec-11.00.Custom_amd64.deb

cd /srv/securedrop
git fetch

sudo apt-get install -y build-essential libssl-dev libffi-dev python-dev dpkg-dev git rsync
sudo apt-get install -y reprepro

for branch in ${1:-{{ packages_refs | join(' ') }}} ; do

    mkdir -p /tmp/$branch
    
    git clean -ffqdx
    git reset --hard origin/$branch
    
    if test "$(cat /tmp/$branch/hash 2>/dev/null)" = "$(git rev-parse origin/$branch)" ; then
        echo "Nothing to do for $branch"
        continue
    fi

    (
        rm -fr /srv/virtualenv
        virtualenv /srv/virtualenv
        source /srv/virtualenv/bin/activate
        pip install -r securedrop/requirements/develop-requirements.txt
        
        make build-debs
    )
    rm -fr /var/www/html/$branch/{pool,dists,db}
    reprepro -Vb /var/www/html/$branch includedeb trusty build/*.deb
    # hack to be removed when kernel 3.14 is no longer distributed
    reprepro -Vb /var/www/html/$branch includedeb trusty linux-*.deb
    if test -d /home/debian/linux-packages ; then
        (
            cd /home/debian/linux-packages/opt
            reprepro -Vb /var/www/html/$branch includedeb trusty *.deb
            reprepro -Vb /var/www/html/$branch includedsc trusty linux-*.dsc
        )
    fi
    git clean -ffqdx
    git rev-parse origin/$branch > /tmp/$branch/hash
done
