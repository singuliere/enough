---
- name: chown debian /srv
  file:
    path: /srv
    owner: debian
  become: true

- name: clone repository
  shell: |
    git clone --bare --mirror {{ mirror_from_repository }}
  args:
    creates: "{{ mirror_from_repository | regex_replace('^.*/', '') }}"
    chdir: /srv

- name: fetch
  cron:
    name: fetch
    minute: '*/5'
    job: cd /srv/"{{ mirror_from_repository | regex_replace('^.*/', '') }}" && flock /tmp/git-mirror git fetch --prune

- name: push
  cron:
    name: push
    minute: '*/5'
    job: cd /srv/"{{ mirror_from_repository | regex_replace('^.*/', '') }}" && flock /tmp/git-mirror git push --mirror "{{ mirror_to_repository }}"
