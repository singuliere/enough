---
#
# the runners registration token is not yet exposed via the API,
# patch the API definition to add it. This will no longer be necessary
# when the corresponding issue is fixed:
#   https://gitlab.com/gitlab-org/gitlab-ce/issues/24030
# and the role is updated to a version that contains the fix.
#
- name: check if runners_registration_token is exposed
  command: docker exec gitlab grep -q runners_registration_token /home/git/gitlab/lib/api/v3/entities.rb
  register: result
  ignore_errors: True

- name: expose runners_registration_token
  shell: |
    set -ex
    docker exec gitlab sed -i -e '/password_authentication_enabled,/a \      expose :runners_registration_token, as: :runners_registration_token' /home/git/gitlab/lib/api/v3/entities.rb
    docker restart gitlab
  when: result|failed
