# deployment require access to
# lab.{{ domain }} but it may be unknown by
# {{ domain }}'s DNS resolver in molecule scenario.
# Moreover, using lab's IP is not an option due to https.
# So we hardcode it in hosts if needed. It should only
# happen in tests scenarios.

- name: ensure access to the real lab.{{ domain }}
  hosts: all

  tasks:
    - name: lookup real lab.{{ domain }}
      command: getent hosts lab.{{ domain }}
      delegate_to: localhost
      register: gitlab_ip

    - name: hardcode lab.{{ domain }} if needed
      lineinfile:
        path: /etc/hosts
        line: "{{ gitlab_ip.stdout }} lab.{{ domain }}"
      become: True
