From 619e01df1eef419486bc36bed74bb9cceebdd8c4 Mon Sep 17 00:00:00 2001
From: Ubuntu <ubuntu@mail.securedrop.club>
Date: Wed, 18 Apr 2018 17:00:23 +0000
Subject: [PATCH] open json unlimited rate access

---
 templates/web.ratelimited.template.yml | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/templates/web.ratelimited.template.yml b/templates/web.ratelimited.template.yml
index ae9cd63..9c4dbfd 100644
--- a/templates/web.ratelimited.template.yml
+++ b/templates/web.ratelimited.template.yml
@@ -24,3 +24,20 @@ run:
          limit_conn connperip $conn_per_ip;
          limit_req zone=flood burst=$burst_per_second nodelay;
          limit_req zone=bot burst=$burst_per_minute nodelay;
+  - replace:
+     filename: "/etc/nginx/conf.d/discourse.conf"
+     from: "# we need buffering off for message bus"
+     to: |
+       # we bypass limits for json
+       location ~ ^/(latest|t/).*\.json {
+         add_header Referrer-Policy 'no-referrer-when-downgrade';
+         add_header Strict-Transport-Security 'max-age=31536042'; # remember the certificate for a year and automatically connect to HTTPS for this domain
+         proxy_set_header Host $http_host;
+         proxy_set_header X-Real-IP $remote_addr;
+         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
+         proxy_set_header X-Forwarded-Proto $thescheme;
+         proxy_pass http://discourse;
+         break;
+       }
+
+       # we need buffering off for message bus
-- 
2.9.3

