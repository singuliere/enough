---
- name: chown debian /srv
  file:
    path: /srv
    owner: debian
  become: True

- name: git clone https://lab.securedrop.club/freedomofpress/securedrop.git
  git:
    repo: 'https://lab.securedrop.club/freedomofpress/securedrop.git'
    version: release/0.6
    force: yes
    dest: /srv/securedrop

- name: install control files
  copy:
    src: "files/{{ item }}"
    dest: /usr/local/bin
    mode: 0755
  become: True
  with_items:
    - rebuild-securedrop-demo.sh
    - start-securedrop-demo.sh
    - stop-securedrop-demo.sh
    - check-securedrop-demo.sh

- name: install cron file
  cron:
    name: check securedrop demo
    job:  timeout 1800 flock /tmp/check-securedrop-demo.lock /usr/local/bin/check-securedrop-demo.sh > /tmp/check-securedrop-demo.log 2>&1
    minute: "*/5"
    user: "{{ ansible_user }}"
    cron_file: check-securedrop-demo
  become: True

- name: build asynchronously vagrant developpement box (fire and forget)
  command: timeout 1800 flock /tmp/check-securedrop-demo.lock /usr/local/bin/check-securedrop-demo.sh
  async: 1000
  poll: 0
