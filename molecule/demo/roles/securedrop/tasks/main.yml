---
- name: apt-get install haveged
  apt:
    name: haveged
    state: present

- name: chown debian /srv
  file:
    path: /srv
    owner: debian
  become: True

- name: mkdir /srv/securedrop
  file:
    state: directory
    path: /srv/securedrop
    owner: debian
  become: True

- name: git clone -b {{ branch }} {{ repository }}
  git:
    update: no
    repo: "{{ repository }}"
    version: "{{ branch }}"
    dest: "/srv/securedrop/{{ demo_name }}"

- name: install script
  template:
    src: check-securedrop-demo.sh
    dest: "/srv/securedrop/check-{{ demo_name }}.sh"
    mode: 0755

- name: install cron
  copy:
    src: "files/cronscript"
    dest: /usr/local/bin/cronscript
    owner: "{{ ansible_user }}"
    mode: 0755
  become: True

- name: cron job to check demo every 5mn
  cron:
    name: check securedrop demo
    minute: "*/5"
    job:  /usr/local/bin/cronscript
    user: "{{ ansible_user }}"

- name: cron job to restart the {{ demo_name }} every 24h
  cron:
    name: "reboot securedrop {{ demo_name }}"
    minute: "59"
    hour: "2"
    job:  "docker rm -f securedrop-{{ demo_name }}"
    user: "{{ ansible_user }}"
