---
- name: apt-get install vagrant libvirt pip ansible and friends
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - vagrant
    - vagrant-libvirt
    - vagrant-mutate
    - libvirt-daemon-system
    - qemu-kvm
    - nfs-common
    - nfs-kernel-server
    - ebtables
    - dnsmasq
    - ansible
    - rsync
    - python-pip

- name: add user to libvirt and kvm groups
  user:
    name: "{{ ansible_user }}"
    groups: libvirt,kvm
    append: yes
  notify:
    - reload kvm and kvm_intel
    - reset ssh connection
  # Resetting ssh connection is due to to allow user
  # changes to affect 'current login user'. See
  # http://docs.ansible.com/ansible/latest/meta_module.html

- name: install vagrant-libvirt
  command: vagrant plugin install vagrant-libvirt
  notify: restart libvirtd

- name: setup libvirt as vagrant default provider
  lineinfile:
    path: /home/{{ ansible_user }}/.bashrc
    line: VAGRANT_DEFAULT_PROVIDER=libvirt

- name: Make sure /srv will be usable by local user
  file:
    dest: '/srv'
    state: 'directory'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Make sure etckeeper is installed
  apt:
    name: etckeeper
    state: present

- name: Make git ignoring vagrant mess in /etc
  lineinfile:
    path: /etc/.gitignore
    line: "{{ item }}"
  with_items:
    - exports
    - libvirt/qemu/securedrop_development.xml
    - apparmor.d/libvirt/libvirt*
