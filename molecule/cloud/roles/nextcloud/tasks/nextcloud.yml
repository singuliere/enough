---
- name: apt-get install git
  apt:
    name: git
    state: present

- name: chown debian /srv
  file:
    path: /srv
    owner: debian

- name: git clone https://github.com/nextcloud/docker/
  git:
    repo: https://github.com/nextcloud/docker/
    version: 13.0.2
    force: yes
    dest: /srv/nextcloud
  become: False

- name: cleanup docker leftovers
  shell: docker system prune --force
  become: False

- name: docker build apache-cron
  shell: docker build -t nextcloud:apache-cron .examples/dockerfiles/cron/apache
  args:
    chdir: /srv/nextcloud
  become: False

- name: Copy docker-compose-securedrop-club.yml
  template:
    src: docker-compose-securedrop-club.yml
    dest: /srv/nextcloud/.examples/docker-compose/with-nginx-proxy/postgres/apache/docker-compose-securedrop-club.yml
    owner: debian
    mode: "0600"
  notify:
    - recreate nextcloud
  become: False

- name: apt-get install tor
  apt:
    name: tor
    state: present

- name: mkdir /var/lib/tor/services
  file:
    state: directory
    dest: /var/lib/tor/services
    owner: debian-tor
    group: debian-tor
    mode: "0700"

- name: mkdir /var/lib/tor/services/cloud
  file:
    state: directory
    dest: /var/lib/tor/services/cloud
    owner: debian-tor
    group: debian-tor
    mode: "0700"

- name: Copy /etc/tor/torrc
  template:
    src: torrc
    dest: /etc/tor/torrc
    mode: "0644"
  notify:
    - restart tor
