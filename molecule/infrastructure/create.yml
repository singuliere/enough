# adapted from molecule/cookiecutter/scenario/driver/openstack/{{cookiecutter.molecule_directory}}/{{cookiecutter.scenario_name}}/create.yml
- name: Create
  hosts: localhost
  connection: local
  gather_facts: False
  vars:
    molecule_file: "{{ lookup('env', 'MOLECULE_FILE') }}"
    molecule_instance_config: "{{ lookup('env', 'MOLECULE_INSTANCE_CONFIG') }}"
    #
    # obtained manually from api.{{ production_domain }}
    #
    enough_api_token: "{{ lookup('env', 'ENOUGH_API_TOKEN') }}"
    molecule_yml: "{{ lookup('file', molecule_file) | from_yaml }}"
    hosts_orig: "{{ lookup('file', '../../hosts-base.yml') | from_yaml }}"
  tasks:

    - name: create instances
      register: stacks
      os_stack:
        auth:
          auth_url: "{{ clouds.ovh.auth.auth_url }}"
          project_name: "{{ clouds.ovh.auth.project_name }}"
          project_id: "{{ clouds.ovh.auth.project_id }}"
          user_domain_name: "{{ clouds.ovh.auth.user_domain_name }}"
          username: "{{ clouds.ovh.auth.username }}"
          password: "{{ clouds.ovh.auth.password }}"
        region_name: "{{ clouds.ovh.region_name }}"
        name: "{{ item.name }}"
        state: present
        template: "../infrastructure/template-host.yaml"
        parameters:
          port: "{% if item.name in hosts_orig.all.hosts %}{{ hosts_orig.all.hosts[item.name].ansible_port | default('') }}{% else %}22{% endif %}"
          flavor: "{{ item.flavor | default('s1-2') }}"
          public_key: "{{ lookup('file', ssh_private_keyfile + '.pub') }}"
          volume_size: "{% if item.volumes is defined %}{{ item.volumes[0].size }}{% else %}0{%endif%}"
          volume_name: "{% if item.volumes is defined %}{{ item.volumes[0].name }}{% else %}noname{%endif%}"
      loop: "{{ molecule_yml.platforms }}"

    - debug:
        var: stacks

    - name: instance configuration for molecule
      set_fact:
        instance_conf: |
          [
            {% for s in stacks.results %}
            {
               'instance': '{{ s.stack.stack_name }}',
               'address': '{{ s.stack.outputs[0].output_value.ipv4 }}',
               'identity_file': '{{ ssh_private_keyfile }}',
               'port': '{{ s.stack.outputs[0].output_value.port }}',
               'user': 'debian',
            },
            {% endfor %}
          ]

    - name: hosts updates for inventory
      set_fact:
        hosts_updates: |
          {
           'all': {
            'hosts': {
             {% for s in stacks.results %}
              '{{ s.stack.name }}':
                {
                  'ansible_port': '{{ s.stack.outputs[0].output_value.port }}',
                  'ansible_host': '{{ s.stack.outputs[0].output_value.ipv4 }}',
                  'ansible_user': 'debian',
                },
             {% endfor %}
            }
           }
          }

    - name: set the default domain to enough.community
      copy:
        content: |
          domain: enough.community
        dest: "../../inventories/common/group_vars/all/domain.yml"

    - block:

        - name: generate subdomain
          shell: date +%s | rev | base32 | tr -d =
          register: cmd

        - set_fact:
            subdomain: "{{ cmd.stdout|lower }}"

        - set_fact:
            domain: "{{ subdomain }}.test.enough.community"

        - name: create DNS delegation for {{ domain }} (requires access to api.{{ production_domain }})
          uri:
            url: https://api.{{ production_domain }}/delegate-test-dns/
            method: POST
            headers:
              Authorization: "Token {{ enough_api_token }}"
            body_format: json
            body: |
              {
                "name": "{{ subdomain }}",
                "ip": "{{ hosts_updates['all']['hosts']['bind-host']['ansible_host'] }}"
              }
            status_code: 201
          register: delegate_dns

        - debug:
            msg: "{{ delegate_dns.json }}"

        - name: save the test sub-domain
          copy:
            content: |
              domain: {{ domain }}
            dest: "../../inventories/common/group_vars/all/domain.yml"

      when: hosts_updates['all']['hosts']['bind-host'] is defined and (letsencrypt_staging | default(false))

    - name: Dump hosts_conf
      copy:
        content: "{{ hosts_orig | combine(hosts_updates, recursive=True) | to_yaml }}"
        dest: "../../inventories/01-hosts.yml"

    - name: Dump instance config
      copy:
        # NOTE(retr0h): Workaround for Ansible 2.2.
        #               https://github.com/ansible/ansible/issues/20885
        content: "{{ instance_conf | to_json | from_json | molecule_to_yaml | molecule_header }}"
        dest: "{{ molecule_instance_config }}"
