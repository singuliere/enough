---
- name: configure firewall
  hosts: localhost
  connection: local
  gather_facts: False
  vars:
    os_security_group_tcp: [ 5665 ]
  tasks:

  - name: configure firewall
    include_role:
      name: firewall


- name: install icinga master

  hosts: all
  become: true
  tasks:

  - name: install icinga master
    include_role:
      name: icinga2
    when:
      - 'monitoring_master == inventory_hostname'

  - name: install letsencrypt
    include_role:
      name: certbot-nginx
    when:
      - 'monitoring_master == inventory_hostname'
      - 'with_https is defined'



- name: install icinga clients
  hosts: all
  become: true
  tasks:

  - name: install icinga client
    include_role:
      name: icinga2_client
    when:
      - 'monitoring_master != inventory_hostname'
      - 'not_monitored is undefined'



- name: install icinga monitoring capabilities
  hosts: all
  become: true
  tasks:

  - name: install icinga monitoring capabilities
    include_role:
      name: icinga2_common
    when:
      - 'not_monitored is undefined'
