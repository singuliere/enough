---
- name: configure firewall
  hosts: localhost
  connection: local
  gather_facts: False
  vars:
    os_security_group_tcp: [ 5665 ]
  tasks:

  - name: configure firewall
    include_role:
      name: firewall


- name: install icinga master

  hosts: icinga-host
  become: true
  tasks:

  - name: install icinga master
    include_role:
      name: icinga2

  - name: install letsencrypt
    include_role:
      name: certbot-nginx
    vars:
      admins_email: "{{ icingaadmins_email }}"
      vhost_fqdn: "{{ icinga_vhost_fqdn }}"
    when:
      - 'with_https is defined'



- name: install icinga clients
  hosts: 'all:!icinga-host'
  become: true
  tasks:

  - name: install icinga client
    include_role:
      name: icinga2_client
    when:
      - 'not_monitored is undefined'



- name: install icinga monitoring capabilities
  hosts: all
  become: true
  tasks:

  - name: install icinga monitoring capabilities
    include_role:
      name: icinga2_common
    when:
      - 'not_monitored is undefined'
