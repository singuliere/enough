---
- name: fetch icinga master info (the tricky way)
  # Perhaps molecule could/should know about it
  shell: |
    openstack server show icinga_host
  register: openstack_output
  delegate_to: localhost
  changed_when: False

- set_fact:
    icinga_master: "icinga_host"

- name: get icinga2 master ip
  shell: |
    awk -F '[|,= ]+' '$2 == "addresses" {print $5}' <<EOF
      {{ openstack_output.stdout }}
    EOF
  register: command_output

- set_fact:
    icinga_master_ip: "{{ command_output.stdout }}"

- name: apt-get install icinga2
  apt:
    name: icinga2
    state: present

- name: apt-get install monitoring-plugins
  apt:
    name: monitoring-plugins
    state: present
    install_recommends: no

- name: retrieve the process user name
  shell: ps -o'user' `pgrep icinga2` | tail -n 1
  register: command_output
  changed_when: False

- set_fact:
    icinga_user: "{{ command_output.stdout }}"

- name: retrieve the process group name
  shell: ps -o'group' `pgrep icinga2` | tail -n 1
  register: command_output
  changed_when: False

- set_fact:
    icinga_group: "{{ command_output.stdout }}"

- name: ensure that /etc/icinga2/pki exists and is owned by the icinga user
  file:
    path: /etc/icinga2/pki
    state: directory
    mode: 0700
    owner: "{{ icinga_user  }}"
    group: "{{ icinga_group }}"

- name: generate a new local self-signed certificate
  shell: |
    icinga2 pki new-cert \
      --cn   {{ inventory_hostname }} \
      --key  /etc/icinga2/pki/{{ inventory_hostname }}.key \
      --cert /etc/icinga2/pki/{{ inventory_hostname }}.crt
  args:
    creates:  /etc/icinga2/pki/{{ inventory_hostname }}.crt

- name: request the master certificate from the master host
  shell: |
    icinga2 pki save-cert \
      --key /etc/icinga2/pki/{{ inventory_hostname }}.key  \
      --cert /etc/icinga2/pki/{{ inventory_hostname }}.crt \
      --trustedcert /etc/icinga2/pki/trusted-master.crt \
      --host {{ icinga_master_ip }}
  args:
    creates:  /etc/icinga2/pki/trusted-master.crt

- name: generate ticket number on master in the "icinga2" docker container
  shell: |
    docker-compose exec -T icinga2      icinga2 pki ticket --cn {{ inventory_hostname }}
  args:
    chdir: /srv/icinga2/
  delegate_to: "{{ icinga_master_ip }}"
  register: command_output
  changed_when: False

- set_fact:
    icinga_ticket: "{{ command_output.stdout }}"

- name: node setup
  shell: |
    icinga2 node setup \
      --ticket {{ icinga_ticket }} \
      --cn {{ inventory_hostname }} \
      --endpoint {{ icinga_master }} \
      --zone {{ inventory_hostname }} \
      --master_host {{ icinga_master_ip }} \
      --trustedcert /etc/icinga2/pki/trusted-master.crt \
      --accept-commands \
      --accept-config
  changed_when: False

- name: disable local configuration
  lineinfile:
    line: 'include_recursive "conf.d"'
    state: absent
    path: /etc/icinga2/icinga2.conf

- name: disable configuration checker
  icinga2_feature:
    name: checker
    state: absent

- name: install global zone on client
  file:
    src: files/zone.conf
    dest: /etc/icinga2/zones.conf

- name: restart icinga client
  systemd:
    name: icinga2
    state: reloaded
  changed_when: False

- name: create zone directory
  file:
    path: /etc/icinga2/zones.d/{{ inventory_hostname }}
    state: directory
  delegate_to: "{{ icinga_master_ip }}"

- name: install node definition on master
  template:
    src: templates/host.conf
    dest: /etc/icinga2/zones.d/{{ inventory_hostname }}/host.conf
  delegate_to: "{{ icinga_master_ip }}"

- name: install client zone definition on master
  template:
    src: templates/client_zone.conf
    dest: /etc/icinga2/zones.d/{{ inventory_hostname }}.conf
  delegate_to: "{{ icinga_master_ip }}"

- name: restart the "icinga2" docker container
  shell: |
    docker-compose restart icinga2
  args:
    chdir: /srv/icinga2/
  delegate_to: "{{ icinga_master_ip }}"
  changed_when: False
