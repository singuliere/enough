- name: declare http vhost on {{ inventory_hostname }}
  # Warn: successives "blockinfile" in the same file require using differents markers
  blockinfile:
    block: |
        vars.http_vhosts["Weblate projects"] = {
          http_vhost = "weblate.securedrop.club"
          http_uri = "/projects/"
          /* http_ssl = true */
          http_string = "<th><a href=\"/projects/securedrop/\">SecureDrop</a></th>"
        }
    insertafter: 'Define httpd services and attributes'
    path: /etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
    marker: "/* {mark} Weblate projects */"
  delegate_to: icinga_host

- name: declare http vhost on {{ inventory_hostname }}
  # Warn: successives "blockinfile" in the same file require using differents markers
  blockinfile:
    block: |
        vars.http_vhosts["Weblate"] = {
          http_vhost = "weblate.securedrop.club"
          http_uri = "/"
          /* http_ssl = true */
          http_string = "Weblate"
        }
    insertafter: 'Define httpd services and attributes'
    path: /etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
    marker: "/* {mark} Weblate Vhost */"
  delegate_to: icinga_host

- name: reload icinga2 configuration
  systemd:
    name: icinga2
    state: reloaded
  changed_when: False
  delegate_to: icinga_host
