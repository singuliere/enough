---
- name: debconf
  shell: |
    debconf-set-selections <<< "postfix postfix/mailname string mail.{{ domain }}"
    debconf-set-selections <<< "postfix postfix/main_mailer_type string 'Internet Site'"
  args:
    executable: /bin/bash
  changed_when: false

- name: apt-get install postfix
  apt:
    name: postfix
    state: present

- name: deconfigure postfix
  lineinfile:
    path: /etc/postfix/main.cf
    line: 'mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128'
    state: absent

- name: configure postfix
  lineinfile:
    path: /etc/postfix/main.cf
    line: 'mynetworks = 127.0.0.0/8 172.17.0.0/24 172.18.0.0/24:'
    state: present

- name: restart postfix
  systemd:
    name: postfix
    state: restarted
  changed_when: False

- name: declare sendmail on monitoring master
  lineinfile:
    line: '  vars.sendmail = true'
    insertafter: 'Define host attributes'
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
  delegate_to: icinga_host

- name: install check_mailq dependancy
  apt:
    name: libfindbin-libs-perl
    state: present

- name: declare sendmail on monitoring master (verify idempotence of lineinfile)
  lineinfile:
    line: '  vars.sendmail = true'
    insertafter: 'Define host attributes'
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
  delegate_to: icinga_host
