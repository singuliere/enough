---
- name: apt-get install git
  apt:
    name: git
    state: present

- name: chown debian /srv
  file:
    path: /srv
    owner: debian

- name: git clone https://github.com/jjethwa/icinga2
  git:
    repo: 'https://github.com/jjethwa/icinga2'
    force: yes
    dest: /srv/icinga2
  register: output
  changed_when: output.before != output.after

- name: Copy docker-compose.yml
  copy:
    src: files/docker-compose.yml
    dest: /srv/icinga2/docker-compose.yml
    mode: "0600"
  changed_when: false

- name: apt-get install virtualenv
  apt:
    name: virtualenv
    state: present

- name: apt-get install python-pip
  apt:
    name: python-pip
    state: present

- name: pip install setuptools
  pip:
    name: setuptools

- name: pip install docker
  pip:
    name: docker

- name: pip install docker-compose
  pip:
    name: docker-compose

- name: launch icinga2 docker
  docker_service:
    project_src: /srv/icinga2
    state: present
  changed_when: false

- name: wait for icinga starting up and conf creation, before tweaking it
  wait_for:
    path: /srv/icinga2/icinga/etc/icinga2/{{ item }}
  with_items:
    - conf.d
    - constants.conf
    - features-available
    - features-enabled
    - icinga2.conf
    - init.conf
    - pki
    - repository.d
    - scripts
    - zones.conf
    - zones.d

- name: wait for icingaweb2 starting up and database setting up
  wait_for:
    port: 80
    state: drained
    delay: 30

- name: install zone definition on master
  template:
    src: templates/zones.conf.master
    dest: /srv/icinga2/icinga/etc/icinga2/zones.conf

- name: create zone directory on master
  file:
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}
    state: directory

- name: install host definition
  template:
    src: templates/host.conf
    dest: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf

- name: create global zone directory
  file:
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/global-templates
    state: directory

- name: remove unused configuration
  file:
    path: /srv/icinga2/icinga/etc/icinga2/conf.d/{{ item }}.conf
    state: absent
  with_items:
    - apt
    - groups
    - services
    - hosts
    - commands
    - downtimes
    - notifications
    - templates
    - timeperiods
    - users

- name: create global services directory
  file:
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/global-templates/services
    state: directory

- name: deploy our global configuration
  copy:
    src:  files/{{ item }}.conf
    dest: /srv/icinga2/icinga/etc/icinga2/zones.d/global-templates/{{ item }}.conf
  with_items:
    - commands
    - downtimes
    - notifications
    - templates
    - timeperiods
    - users
    - groups
    - services/apt
    - services/base
    - services/database
    - services/disks
    - services/dns
    - services/http
    - services/mail
    - services/volumes

- name: reload icinga2 configuration
  shell: |
    docker-compose exec -T icinga2      /etc/init.d/icinga2 reload
  args:
    chdir: /srv/icinga2/
  changed_when: False
