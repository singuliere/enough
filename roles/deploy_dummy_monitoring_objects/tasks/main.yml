---
- name: declare http vhost on {{ inventory_hostname }}
  # Warn: successives "blockinfile" in the same file require using differents markers
  blockinfile:
    block: |
        vars.http_vhosts["Secure Drop Forum"] = {
          http_vhost = "forum.securedrop.club"
          http_uri = "/c/devops"
          http_ssl = true
          http_string = "devops discussions"
        }
    insertafter: 'Define httpd services and attributes'
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
    marker: "/* {mark} Secure Drop Forum Vhost */"
  delegate_to: icinga_host

- name: declare process on {{ inventory_hostname }}
  # Warn: successives "blockinfile" in the same file require using differents markers
  blockinfile:
    block: |
        vars.process["Systemd login"] = {
        procs_command = "systemd-logind"
          procs_critical = "1:1"
        }
    insertafter: 'Define processes and attributes'
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/{{ inventory_hostname }}/host.conf
    marker: "/* {mark} Systemd login process */"
  delegate_to: icinga_host

- name: install check_git on icinga_host
  copy:
    src: files/check_git
    dest: /usr/local/bin/check_git
    mode: 0755
  delegate_to: icinga_host

- name: install sudo file for check_git on icinga_host
  template:
    dest: /etc/sudoers.d/icinga2_check_git
    src: templates/icinga2_check_git
  delegate_to: icinga_host

- name: declare git repo on icinga_host
  # Warn: successives "blockinfile" in the same file require using differents markers
  blockinfile:
    block: |
        vars.repos["Icinga2 Docker image"] = {
          dir = "/src/icinga2"
        }
    insertafter: 'Define git repos and attributes'
    path: /srv/icinga2/icinga/etc/icinga2/zones.d/master/icinga_host/host.conf
    marker: "/* {mark} Icinga2 Docker image git repo */"
  delegate_to: icinga_host

- name: reload icinga2 configuration
  shell: |
    docker-compose exec -T icinga2      /etc/init.d/icinga2 reload
  args:
    chdir: /srv/icinga2/
  delegate_to: icinga_host
  changed_when: False
